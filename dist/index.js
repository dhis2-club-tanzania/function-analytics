!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("@iapps/function-analytics",[],t):"object"==typeof exports?exports["@iapps/function-analytics"]=t():e["@iapps/function-analytics"]=t()}("undefined"!=typeof self?self:this,function(){return(()=>{var s={501:function(r,n,i){var a;/*! https://mths.be/base64 v1.0.0 by @mathias | MIT license */r=i.nmd(r),function(){r&&r.exports;var e="object"==typeof i.g&&i.g;e.global!==e&&e.window;function t(e){this.message=e}(t.prototype=new Error).name="InvalidCharacterError";function h(e){throw new t(e)}var u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=/[\t\n\f\r ]/g,s={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&h("The string to be encoded contains characters outside of the Latin1 range.");for(var t,s,r,n,i=e.length%3,a="",o=-1,c=e.length-i;++o<c;)t=e.charCodeAt(o)<<16,s=e.charCodeAt(++o)<<8,r=e.charCodeAt(++o),a+=u.charAt((n=t+s+r)>>18&63)+u.charAt(n>>12&63)+u.charAt(n>>6&63)+u.charAt(63&n);return 2==i?(t=e.charCodeAt(o)<<8,s=e.charCodeAt(++o),a+=u.charAt((n=t+s)>>10)+u.charAt(n>>4&63)+u.charAt(n<<2&63)+"="):1==i&&(n=e.charCodeAt(o),a+=u.charAt(n>>2)+u.charAt(n<<4&63)+"=="),a},decode:function(e){var t=(e=String(e).replace(o,"")).length;(t=t%4==0?(e=e.replace(/==?$/,"")).length:t)%4!=1&&!/[^+a-zA-Z0-9/]/.test(e)||h("Invalid character: the string to be decoded is not correctly encoded.");for(var s,r,n=0,i="",a=-1;++a<t;)r=u.indexOf(e.charAt(a)),s=n%4?64*s+r:r,n++%4&&(i+=String.fromCharCode(255&s>>(-2*n&6)));return i},version:"1.0.0"};void 0===(a=function(){return s}.call(n,i,n,r))||(r.exports=a)}()},446:e=>{"use strict";const r=Symbol?Symbol():"__listeners";class t extends Promise{constructor(t){super((e,s)=>t(e,s,t=>{try{return this[r].forEach(e=>e(t))}catch(e){s(e)}})),this[r]=[]}progress(e){if("function"!=typeof e)throw new Error("PROGRESS_REQUIRES_FUNCTION");return this[r].push(e),this}static all(e){const i=new Array(e.length),a=e.length;let o=0;return new t((s,r,n)=>{e.forEach((e,t)=>{e.then(e=>{i[t]=e,i.proportion=++o/a,n(i),o===a&&s(i)}).catch(r)})})}static sequence(n,i){const a=[],o=n.length;let c=0;return new t((s,e,r)=>{!function t(){i.call(null,n[a.length]).then(e=>{a.push(e),a.proportion=++c/o,r(a),a.length===o?s(a):t()}).catch(e)}()})}}e.exports=t},622:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Analytics=void 0;const n=s(267);class r extends s(11).Fetcher{constructor(t=25){super(),"boolean"==typeof t&&(t=t?25:26),this.parameters.dimension={},this.postProcess(e=>this.standardizeAnalytics(e,t))}setData(e){return this.setDimension("dx",e),this}setPeriod(e){return this.setDimension("pe",e),this}setOrgUnit(e){return this.setDimension("ou",e),this}setSelections(e){return this.setPeriod(e.pe),this.setOrgUnit(e.ou),void 0!==e.rule.json.data&&this.setData(e.rule.json.data),void 0!==e.dimensions&&Array.isArray(e.dimensions)&&e.dimensions.forEach(function(e){if(Array.isArray(e.items)){let t="";e.items.forEach(function(e){0<t.length?t+=";"+e:t+=e}),this.setDimension(e.id,t)}}),this}setDimension(e,t){return this.parameters.dimension[e]=t||"",this}standardizeAnalytics(e,t=25){if("boolean"==typeof t&&(t=t?25:26),e.count)return new n.AnalyticsResult(e);let s={headers:[],metaData:{dimensions:{},names:{},dx:[],pe:[],ou:[],co:[]},rows:[]};if(e){if(e.headers&&e.headers.forEach(e=>{try{var t=e;s.headers.push(t)}catch(e){console.warn("Invalid header object")}}),e.metaData)try{var r=this.getSanitizedAnalyticsMetadata(e.metaData,t);s.metaData=r}catch(e){console.warn("Invalid metadata object")}e.rows&&(s.rows=e.rows)}return s.height=e.height,s.width=e.width,new n.AnalyticsResult(s)}getSanitizedAnalyticsMetadata(t,e){let s={};return t&&(t.ouHierarchy&&(s.ouHierarchy=t.ouHierarchy),e<26?(s.names={},t.names?s.names=t.names:t.items&&Object.keys(t.items).forEach(e=>{s.names[e]=t.items[e].name}),t.dimensions&&Object.keys(t.dimensions).forEach(e=>{s[e]=t.dimensions[e]})):(s.items={},t.items?s.items=t.items:t.names&&Object.keys(t.items).forEach(e=>{t.items[e]={name:t.names[e]}}),t.dimensions?s.dimensions=t.dimensions:(s.dimensions={},Object.keys(t).forEach(e=>{-1===["names","items","dimensions"].indexOf(e)&&(s.dimensions[e]=t[e])})))),s}get url(){return"analytics?"+this._urlParameters}}t.Analytics=r},321:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventAnalytics=void 0;class r extends s(622).Analytics{setProgram(e){return this._program=e,this}get url(){return"analytics/events/query/"+this._program+"?"+this._urlParameters}}t.EventAnalytics=r},520:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdentifiableObject=void 0;class r extends s(11).Fetcher{constructor(e){super(),this._filters=[],this._objectName=e}get name(){return this._objectName}where(e,t,s){return this._filters.push({right:e,operator:t,left:s}),this}get url(){var t=this._urlParameters;return this._filters.forEach(e=>{""!==t&&(t+="&"),t+="filter="+e.right,"=="===e.operator?t+=":eq:"+e.left:"<"===e.operator?t+=":lt:"+e.left:"<="===e.operator?t+=":le:"+e.left:">"===e.operator?t+=":gt:"+e.left:">="===e.operator?t+=":ge:"+e.left:"<>"===e.operator?t+=":!eq:"+e.left:"in"===e.operator||"!in"===e.operator?t+=":"+e.operator+":["+e.left+"]":e.left?t+=":"+e.operator+":"+e.left:t+=":"+e.operator}),this.name+".json?"+t}}t.IdentifiableObject=r},997:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SQLViewData=void 0;class r extends s(11).Fetcher{constructor(e){super(),this._id=e,this.parameters.var={}}setVariable(e,t){return this.parameters.var[e]=t||"",this}get url(){return"sqlViews/"+this._id+"/data.json?"+this._urlParameters}}t.SQLViewData=r},267:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsResult=t.AnalyticsHeaders=t.AnalyticsHeader=void 0;const r=s(580);t.AnalyticsHeader=class{};class n extends Array{constructor(e){super(...e),Object.setPrototypeOf(this,Object.create(n.prototype))}get dx(){return this.getHeader("dx")}get pe(){return this.getHeader("pe")}get ou(){return this.getHeader("ou")}get value(){return this.getHeader("value")}getHeader(s){let r;return this.forEach((e,t)=>{e.name===s&&(r=e,r.index=t)}),r}}t.AnalyticsHeaders=n;t.AnalyticsResult=class{constructor(e){this._data=e}get headers(){return new n(this._data.headers)}get metaData(){return this._data.metaData}getDimensionDetailsByName(e){var t=[];return this.metaData.dimensions&&this.metaData.dimensions[e].forEach(e=>{t.push(this.getDimensionDetails(e))}),t}get rows(){let t=[];return this._data.rows.forEach(e=>{t.push(new r.Row(e,this.headers,this.metaData))}),t}getDimensionDetails(e){var t="";return this.metaData.names?t=this.metaData.names[e]:this.metaData.items&&(t=this.metaData.items[e]?this.metaData.items[e].name:void 0),{id:e,name:t,path:this.metaData.ouHierarchy&&void 0!==this.metaData.ouHierarchy[e]?this.metaData.ouHierarchy[e]:void 0}}get height(){return this._data.height}get width(){return this._data.width}}},177:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dependency=void 0;t.Dependency=class{constructor(e,t){this.process=e,this.processCallback=t}}},971:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FetchConfig=void 0;const r=s(501);t.FetchConfig=class{constructor(e){this.config=null==e?void 0:e.config,this.method=(null==e?void 0:e.method)||"GET",this.contentType=(null==e?void 0:e.contentType)||"application/json",this._url=null==e?void 0:e.url}get authorization(){if(this.config.username&&this.config.password)return`Basic ${r.encode(this.config.username+":"+this.config.password)}`}get headers(){var e={"Content-Type":this.contentType};return this.authorization?{...e,Authorization:this.authorization}:e}get url(){if(!this._url)throw"No url passed";return this.config.baseUrl+this._url}get fetchConfig(){return{method:this.method,headers:this.headers}}}},11:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fetcher=void 0;const r=s(393);var n=s(371);const i=s(446);class a extends n.Process{constructor(){super(),this.parameters={}}get _urlParameters(){let s="";return Object.keys(this.parameters).forEach(t=>{""!==s&&(s+="&"),"string"==typeof this.parameters[t]?s+=t+"="+this.parameters[t]:Object.keys(this.parameters[t]).forEach(e=>{""!==s&&(s+="&"),""===this.parameters[t][e]?s+=t+"="+e:s+=t+"="+e+":"+this.parameters[t][e]})}),s}get url(){throw new Error("Should implement url generation")}get(){var e;return null===(e=r.Runner.getInstance())||void 0===e?void 0:e.getResults(this)}setParameters(t){return Object.keys(t).forEach(e=>{this.parameters[e]=t[e]}),this}getDependecyFetchResults(){var e=this.dependencies.map(e=>{var t;return null===(t=r.Runner.getInstance())||void 0===t?void 0:t.getResults(e.process)});return i.default.all(e)}_encode64(e){return btoa(new Uint8Array(e).reduce((e,t)=>e+String.fromCharCode(t),""))}hash(){return this.url}}t.Fetcher=a},637:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultiFetcher=void 0;const r=s(393);class n extends s(11).Fetcher{constructor(e){super(),this._fetchers=e}get fetchers(){return this._fetchers}get(){const e=r.Runner.getInstance();return e.getAllResults(this)}}t.MultiFetcher=n},371:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Process=void 0;t.Process=class{constructor(){this.postProcessors=[],this.dependencies=[]}hasDependencies(){return 0<this.dependencies.length}preProcess(e){return this.dependencies.push(e),this}addPreProcess(e){return this.dependencies.push(e),this}postProcess(e){return this.postProcessors.push(e),this}addPostProcess(e){return this.postProcessors.push(e),this}performPreProcess(){return this.dependencies.forEach(e=>{e.processCallback(e.process._results,this)}),this}performPostProcess(e){let t=this._results=e;return this.postProcessors.forEach(e=>{t=e(t)}),t}}},580:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Row=void 0;t.Row=class{constructor(e,t,s){this.row=e,this.headers=t,this.metaData=s}dimension(s){var r=-1,e="";return this.headers.forEach((e,t)=>{e.name===s&&(r=t)}),this.metaData.names?e=this.metaData.names[this.row[r]]:this.metaData.items&&(e=this.metaData.items[this.row[r]]?this.metaData.items[this.row[r]].name:void 0),{id:this.row[r],name:e,path:this.metaData.ouHierarchy&&void 0!==this.metaData.ouHierarchy[this.row[r]]?this.metaData.ouHierarchy[this.row[r]]:void 0}}get dx(){return this.dimension("dx")}get pe(){return this.dimension("pe")}get ou(){return this.dimension("ou")}get value(){return this.dimension("value").id}}},393:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Runner=void 0;const i=s(971);class r{constructor(e){this.cache={},e&&(this.config=e)}static initiateRunner(e){r._instance||(r._instance=new r(e))}get instance(){return this}static getInstance(){return r.initiateRunner(),r._instance}set config(e){this.config=e}get config(){return this.config}_fetch(t,s,r){if(!this.instance)throw Error('Configuration not set please configure function analytics eg {baseUrl:"dhis_base_url", username:"username", password:"password"}');let n=t.hash();var e;this.cache[n]?this.cache[n].finished?s(t.performPostProcess(JSON.parse(JSON.stringify(this.cache[n].data)))):this.cache[n].resolutions.push(s):(this.cache[n]={finished:!1,resolutions:[]},e=new i.FetchConfig({config:this.config,method:"GET",url:t.url}),fetch(e.url,e.fetchConfig).then(async e=>{this.cache[n].data=await e.json(),console.log(this.cache[n].data),s(t.performPostProcess(JSON.parse(JSON.stringify(this.cache[n].data)))),this.cache[n].resolutions.forEach(e=>{e(t.performPostProcess(JSON.parse(JSON.stringify(this.cache[n].data))))}),this.cache[n].finished=!0},e=>{r(e)}))}getResults(s){return s.fetchers?this.getAllResults(s):new Promise((e,t)=>{s.hasDependencies()?s.getDependecyFetchResults().then(()=>{s.performPreProcess(),this._fetch(s,e,t)}).catch(e=>{console.log(e),t()}):this._fetch(s,e,t)})}getAllResults(r){return new Promise((t,s)=>{var e=r.fetchers.map(e=>this.getResults(e));return Promise.all(e).then(e=>{t(r.performPostProcess(e))}).catch(e=>{s(e)})})}}t.Runner=r}},r={};function d(e){var t=r[e];if(void 0!==t)return t.exports;t=r[e]={id:e,loaded:!1,exports:{}};return s[e].call(t.exports,t,t.exports,d),t.loaded=!0,t.exports}d.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),d.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var f={};return(()=>{"use strict";var e=f;Object.defineProperty(e,"__esModule",{value:!0}),e.Dependency=e.MultiFetcher=e.Runner=e.SQLViewData=e.IdentifiableObject=e.AnalyticsResult=e.EventAnalytics=e.Analytics=e.all=e.init=e.Fn=void 0;const t=d(637);Object.defineProperty(e,"MultiFetcher",{enumerable:!0,get:function(){return t.MultiFetcher}});const s=d(393);Object.defineProperty(e,"Runner",{enumerable:!0,get:function(){return s.Runner}});const r=d(622);Object.defineProperty(e,"Analytics",{enumerable:!0,get:function(){return r.Analytics}});const n=d(321);Object.defineProperty(e,"EventAnalytics",{enumerable:!0,get:function(){return n.EventAnalytics}});const i=d(267);Object.defineProperty(e,"AnalyticsResult",{enumerable:!0,get:function(){return i.AnalyticsResult}});const a=d(520);Object.defineProperty(e,"IdentifiableObject",{enumerable:!0,get:function(){return a.IdentifiableObject}});const o=d(997);Object.defineProperty(e,"SQLViewData",{enumerable:!0,get:function(){return o.SQLViewData}});const c=d(177);function h(e){s.Runner.initiateRunner(e)}function u(e){return new t.MultiFetcher(e)}Object.defineProperty(e,"Dependency",{enumerable:!0,get:function(){return c.Dependency}}),e.init=h,e.all=u;var l={Analytics:r.Analytics,EventAnalytics:n.EventAnalytics,AnalyticsResult:i.AnalyticsResult,IdentifiableObject:a.IdentifiableObject,SQLViewData:o.SQLViewData,Runner:s.Runner,Dependency:c.Dependency,MultiFetcher:t.MultiFetcher,all:u,init:h};e.Fn=l,"undefined"!=typeof window&&(window.Fn=l)})(),f})()});