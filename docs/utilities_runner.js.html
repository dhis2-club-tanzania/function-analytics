<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>utilities/runner.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Fn.html">Fn</a><ul class='methods'><li data-type='method'><a href="Fn.html#.all">all</a></li><li data-type='method'><a href="Fn.html#.init">init</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-Analytics_.html">Analytics</a><ul class='methods'><li data-type='method'><a href="Analytics.html#get">get</a></li><li data-type='method'><a href="Analytics.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="Analytics.html#getSanitizedAnalyticsMetadata">getSanitizedAnalyticsMetadata</a></li><li data-type='method'><a href="Analytics.html#setData">setData</a></li><li data-type='method'><a href="Analytics.html#setDimension">setDimension</a></li><li data-type='method'><a href="Analytics.html#setOrgUnit">setOrgUnit</a></li><li data-type='method'><a href="Analytics.html#setParameters">setParameters</a></li><li data-type='method'><a href="Analytics.html#setPeriod">setPeriod</a></li><li data-type='method'><a href="Analytics.html#setSelections">setSelections</a></li><li data-type='method'><a href="Analytics.html#standardizeAnalytics">standardizeAnalytics</a></li></ul></li><li><a href="tutorial-Generic-Functions.html">Generic-Functions</a></li></ul><h3>Classes</h3><ul><li><a href="Analytics.html">Analytics</a><ul class='methods'><li data-type='method'><a href="Analytics.html#get">get</a></li><li data-type='method'><a href="Analytics.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="Analytics.html#getSanitizedAnalyticsMetadata">getSanitizedAnalyticsMetadata</a></li><li data-type='method'><a href="Analytics.html#setData">setData</a></li><li data-type='method'><a href="Analytics.html#setDimension">setDimension</a></li><li data-type='method'><a href="Analytics.html#setOrgUnit">setOrgUnit</a></li><li data-type='method'><a href="Analytics.html#setParameters">setParameters</a></li><li data-type='method'><a href="Analytics.html#setPeriod">setPeriod</a></li><li data-type='method'><a href="Analytics.html#setSelections">setSelections</a></li><li data-type='method'><a href="Analytics.html#standardizeAnalytics">standardizeAnalytics</a></li></ul></li><li><a href="AnalyticsHeader.html">AnalyticsHeader</a></li><li><a href="AnalyticsHeaders.html">AnalyticsHeaders</a><ul class='methods'><li data-type='method'><a href="AnalyticsHeaders.html#getHeader">getHeader</a></li></ul></li><li><a href="AnalyticsResult.html">AnalyticsResult</a><ul class='methods'><li data-type='method'><a href="AnalyticsResult.html#getDimensionDetails">getDimensionDetails</a></li><li data-type='method'><a href="AnalyticsResult.html#getDimensionDetailsByName">getDimensionDetailsByName</a></li></ul></li><li><a href="Dependency.html">Dependency</a></li><li><a href="EventAnalytics.html">EventAnalytics</a><ul class='methods'><li data-type='method'><a href="EventAnalytics.html#get">get</a></li><li data-type='method'><a href="EventAnalytics.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="EventAnalytics.html#getSanitizedAnalyticsMetadata">getSanitizedAnalyticsMetadata</a></li><li data-type='method'><a href="EventAnalytics.html#setData">setData</a></li><li data-type='method'><a href="EventAnalytics.html#setDimension">setDimension</a></li><li data-type='method'><a href="EventAnalytics.html#setOrgUnit">setOrgUnit</a></li><li data-type='method'><a href="EventAnalytics.html#setParameters">setParameters</a></li><li data-type='method'><a href="EventAnalytics.html#setPeriod">setPeriod</a></li><li data-type='method'><a href="EventAnalytics.html#setProgram">setProgram</a></li><li data-type='method'><a href="EventAnalytics.html#setSelections">setSelections</a></li><li data-type='method'><a href="EventAnalytics.html#standardizeAnalytics">standardizeAnalytics</a></li></ul></li><li><a href="Fetcher.html">Fetcher</a><ul class='methods'><li data-type='method'><a href="Fetcher.html#addPostProcess">addPostProcess</a></li><li data-type='method'><a href="Fetcher.html#addPreProcess">addPreProcess</a></li><li data-type='method'><a href="Fetcher.html#get">get</a></li><li data-type='method'><a href="Fetcher.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="Fetcher.html#hasDependencies">hasDependencies</a></li><li data-type='method'><a href="Fetcher.html#performPostProcess">performPostProcess</a></li><li data-type='method'><a href="Fetcher.html#performPreProcess">performPreProcess</a></li><li data-type='method'><a href="Fetcher.html#postProcess">postProcess</a></li><li data-type='method'><a href="Fetcher.html#preProcess">preProcess</a></li><li data-type='method'><a href="Fetcher.html#setParameters">setParameters</a></li></ul></li><li><a href="IdentifiableObject.html">IdentifiableObject</a><ul class='methods'><li data-type='method'><a href="IdentifiableObject.html#get">get</a></li><li data-type='method'><a href="IdentifiableObject.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="IdentifiableObject.html#setParameters">setParameters</a></li><li data-type='method'><a href="IdentifiableObject.html#where">where</a></li></ul></li><li><a href="MultiFetcher.html">MultiFetcher</a><ul class='methods'><li data-type='method'><a href="MultiFetcher.html#addPostProcess">addPostProcess</a></li><li data-type='method'><a href="MultiFetcher.html#addPreProcess">addPreProcess</a></li><li data-type='method'><a href="MultiFetcher.html#get">get</a></li><li data-type='method'><a href="MultiFetcher.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="MultiFetcher.html#hasDependencies">hasDependencies</a></li><li data-type='method'><a href="MultiFetcher.html#performPostProcess">performPostProcess</a></li><li data-type='method'><a href="MultiFetcher.html#performPreProcess">performPreProcess</a></li><li data-type='method'><a href="MultiFetcher.html#postProcess">postProcess</a></li><li data-type='method'><a href="MultiFetcher.html#preProcess">preProcess</a></li><li data-type='method'><a href="MultiFetcher.html#setParameters">setParameters</a></li></ul></li><li><a href="Period.html">Period</a><ul class='methods'><li data-type='method'><a href="Period.html#setType">setType</a></li></ul></li><li><a href="Process.html">Process</a><ul class='methods'><li data-type='method'><a href="Process.html#addPostProcess">addPostProcess</a></li><li data-type='method'><a href="Process.html#addPreProcess">addPreProcess</a></li><li data-type='method'><a href="Process.html#hasDependencies">hasDependencies</a></li><li data-type='method'><a href="Process.html#performPostProcess">performPostProcess</a></li><li data-type='method'><a href="Process.html#performPreProcess">performPreProcess</a></li><li data-type='method'><a href="Process.html#postProcess">postProcess</a></li><li data-type='method'><a href="Process.html#preProcess">preProcess</a></li></ul></li><li><a href="ProgressPromise.html">ProgressPromise</a><ul class='methods'><li data-type='method'><a href="ProgressPromise.html#.all">all</a></li><li data-type='method'><a href="ProgressPromise.html#.sequence">sequence</a></li><li data-type='method'><a href="ProgressPromise.html#progress">progress</a></li></ul></li><li><a href="Row.html">Row</a><ul class='methods'><li data-type='method'><a href="Row.html#dimension">dimension</a></li></ul></li><li><a href="Runner.html">Runner</a><ul class='methods'><li data-type='method'><a href="Runner.html#.initiateRunner">initiateRunner</a></li><li data-type='method'><a href="Runner.html#getAllResults">getAllResults</a></li><li data-type='method'><a href="Runner.html#getResults">getResults</a></li></ul></li><li><a href="SQLViewData.html">SQLViewData</a><ul class='methods'><li data-type='method'><a href="SQLViewData.html#get">get</a></li><li data-type='method'><a href="SQLViewData.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="SQLViewData.html#setParameters">setParameters</a></li><li data-type='method'><a href="SQLViewData.html#setVariable">setVariable</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#processCallback">processCallback</a></li><li><a href="global.html#rejectCallback">rejectCallback</a></li><li><a href="global.html#resolveCallback">resolveCallback</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">utilities/runner.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ProgressPromise from 'progress-promise';
import axios from 'axios';
import httpadapter from 'axios/lib/adapters/http';
import xhradapter from 'axios/lib/adapters/xhr';
let _instance;

/**
 * Runner represents the process which will schedule and run operations of the processes
 */
export class Runner {
  /**
   * Initiates the runner singleton instance
   * @param configurations
   */
  static initiateRunner(configurations) {
    if (!Runner.instance) {
      this.config = configurations;
      this.cache = {};
      _instance = this;
    }
  }

  /**
   * Get the Runner instance
   * @returns {Runner}
   */
  get instance() {
    return _instance;
  }

  /**
   * Set the configuration
   * @param configurations
   */
  set config(configurations) {
    this.config = configurations;
  }

  /**
   * Get the configurations
   * @returns {*}
   */
  get config() {
    return this.config;
  }

  /**
   * This callback type is called `resolveCallback`.
   *
   * @callback resolveCallback
   * @param {Object} responseResult
   */

  /**
   * This callback type is called `rejectCallback`.
   *
   * @callback rejectCallback
   * @param {Error} error
   */

  /**
   * Fetches the data from the fetcher
   * @param {Fetcher} fetcher
   * @param {resolveCallback} resolve
   * @param {rejectCallback} reject
   * @private
   */
  _fetch(fetcher, resolve, reject) {
    if (!_instance) {
      let error =
        'Configration not set please configre function ' +
        'analytics eg {baseUrl:"dhis_base_url", username:"username", ' +
        'password:"password"}';

      throw Error(error);
    }
    let hashed = fetcher.hash();

    if (!_instance.cache[hashed]) {
      _instance.cache[hashed] = {
        finished: false,
        resolutions: []
      };
      const config = {
        url: _instance.config.baseUrl + fetcher.url,
        method: 'get',
        adapter: typeof process !== 'undefined' ? httpadapter : xhradapter
      };

      if (_instance.config.username &amp;&amp; _instance.config.password) {
        config.auth = {
          username: _instance.config.username,
          password: _instance.config.password
        };
      }
      axios.request(config).then(
        results => {
          _instance.cache[hashed].data = results.data;
          resolve(fetcher.performPostProcess(JSON.parse(JSON.stringify(_instance.cache[hashed].data))));
          _instance.cache[hashed].resolutions.forEach(function (resolution) {
            resolution(fetcher.performPostProcess(JSON.parse(JSON.stringify(_instance.cache[hashed].data))));
          });
          _instance.cache[hashed].finished = true;
        },
        err => {
          reject(err);
        }
      );
    } else {
      if (!_instance.cache[hashed].finished) {
        _instance.cache[hashed].resolutions.push(resolve);
      } else {
        resolve(fetcher.performPostProcess(JSON.parse(JSON.stringify(_instance.cache[hashed].data))));
      }
    }
  }

  /**
   * Fetches data related to a fetcher
   * @param {Fetcher} fetcher
   * @returns {ProgressPromise}
   */
  getResults(fetcher) {
    if (fetcher._fetchers) {
      // If is a multifetcher
      return this.getAllResults(fetcher);
    }
    // let hashed = fetcher.hash();

    // if (!_instance.cache[hashed]) {
    //   _instance.cache[hashed] = new ProgressPromise(
    //     (resolve, reject, progress) => {
    //       if (fetcher.hasDependencies()) {
    //         fetcher
    //           .getDependecyFetchResults()
    //           .then(() => {
    //             fetcher.performPreProcess();
    //             this._fetch(fetcher, resolve, reject);
    //           })
    //           .catch(err => {
    //             console.log('Errrrrrrrrrr:', err);
    //             reject();
    //           });
    //       } else {
    //         this._fetch(fetcher, resolve, reject);
    //       }
    //     }
    //   );
    // }
    return new ProgressPromise(
      (resolve, reject, progress) => {
        if (fetcher.hasDependencies()) {
          fetcher
            .getDependecyFetchResults()
            .then(() => {
              fetcher.performPreProcess();
              this._fetch(fetcher, resolve, reject);
            })
            .catch(err => {
              console.log('Errrrrrrrrrr:', err);
              reject();
            });
        } else {
          this._fetch(fetcher, resolve, reject);
        }
      }
    );
  }

  /**
   * Fetches data for multiple fetchers
   * @param {MultiFetcher} multifetcher
   * @returns {ProgressPromise}
   */
  getAllResults(multifetcher) {
    return new ProgressPromise((resolve, reject, progress) => {
      const promises = multifetcher.fetchers.map(fetcher =>
        new Runner().getResults(fetcher)
      );

      return ProgressPromise.all(promises)
        .then(results => {
          resolve(multifetcher.performPostProcess(results));
        })
        .catch(err => {
          reject(err);
        });
    });
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Jul 03 2019 20:49:33 GMT+0300 (East Africa Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
